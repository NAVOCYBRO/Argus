import requests
import re
from urllib.parse import urljoin

class VulnerabilityChecker:
    def __init__(self):
        self.vulnerable_paths = [
            '/admin/', '/phpmyadmin/', '/wp-admin/', '/administrator/',
            '/.git/', '/.env', '/config.php', '/backup/', '/backups/',
            '/api/', '/v1/', '/v2/', '/swagger-ui/', '/graphql',
            '/debug', '/console', '/actuator', '/manager/html',
            '/server-status', '/phpinfo.php', '/test/', '/demo/'
        ]
        
        self.common_vulnerabilities = {
            'ssh': ['weak_keys', 'default_credentials', 'protocol_v1'],
            'ftp': ['anonymous_login', 'clear_text', 'bounce_attack'],
            'http': ['directory_listing', 'http_methods', 'headers_exposed'],
            'https': ['weak_cipher', 'ssl_v2_v3', 'heartbleed'],
            'smb': ['eternalblue', 'sambaCry', 'null_session'],
            'mysql': ['weak_password', 'root_access', 'version_exposed']
        }
    
    def check_all_vulnerabilities(self, target, services):
        """Check for various vulnerabilities"""
        vulnerabilities = {
            'misconfigurations': [],
            'common_vulns': [],
            'web_vulns': [],
            'critical_findings': []
        }
        
        # Check web vulnerabilities if HTTP/HTTPS ports open
        web_ports = [80, 443, 8080, 8443, 8000, 3000]
        for service in services:
            if service['port'] in web_ports:
                web_vulns = self.check_web_vulnerabilities(target, service['port'])
                vulnerabilities['web_vulns'].extend(web_vulns)
            
            # Check for common service vulnerabilities
            service_vulns = self.check_service_vulnerabilities(service)
            vulnerabilities['common_vulns'].extend(service_vulns)
        
        # Check for misconfigurations
        misconfigs = self.check_misconfigurations(target)
        vulnerabilities['misconfigurations'].extend(misconfigs)
        
        # Check for critical issues
        critical = self.check_critical_issues(target, services)
        vulnerabilities['critical_findings'].extend(critical)
        
        return vulnerabilities
    
    def check_web_vulnerabilities(self, target, port):
        """Check web application vulnerabilities"""
        vulns = []
        protocol = 'https' if port == 443 else 'http'
        base_url = f"{protocol}://{target}:{port}"
        
        try:
            # Check common vulnerable paths
            for path in self.vulnerable_paths:
                url = urljoin(base_url, path)
                try:
                    response = requests.get(url, timeout=3, verify=False)
                    if response.status_code in [200, 301, 302]:
                        vulns.append({
                            'type': 'exposed_path',
                            'path': path,
                            'url': url,
                            'status': response.status_code,
                            'risk': 'medium' if 'admin' in path else 'low'
                        })
                except:
                    continue
            
            # Check security headers
            try:
                response = requests.get(base_url, timeout=3, verify=False)
                headers = response.headers
                
                security_checks = [
                    ('X-Frame-Options', 'clickjacking'),
                    ('X-Content-Type-Options', 'mime_sniffing'),
                    ('X-XSS-Protection', 'xss_protection'),
                    ('Content-Security-Policy', 'csp_missing'),
                    ('Strict-Transport-Security', 'hsts_missing')
                ]
                
                for header, issue in security_checks:
                    if header not in headers:
                        vulns.append({
                            'type': 'missing_header',
                            'header': header,
                            'issue': issue,
                            'risk': 'low'
                        })
                        
            except:
                pass
                
        except Exception as e:
            print(f"Web vulnerability check failed: {e}")
        
        return vulns
    
    def check_service_vulnerabilities(self, service):
        """Check for common service vulnerabilities"""
        vulns = []
        service_name = service['name'].lower()
        
        # Version-based vulnerabilities
        if service.get('version'):
            version = service['version']
            
            # SSH specific checks
            if 'ssh' in service_name:
                if '7.' in version and 'p1' not in version:
                    vulns.append({
                        'type': 'ssh_version',
                        'service': 'ssh',
                        'version': version,
                        'issue': 'Potential outdated SSH version',
                        'risk': 'medium'
                    })
            
            # Web server checks
            if 'apache' in service_name or 'nginx' in service_name or 'iis' in service_name:
                vulns.append({
                    'type': 'server_version_exposed',
                    'service': service_name,
                    'version': version,
                    'issue': 'Server version exposed',
                    'risk': 'low'
                })
        
        # Port-specific vulnerabilities
        if service['port'] == 21:  # FTP
            vulns.append({
                'type': 'ftp_clear_text',
                'issue': 'FTP transmits credentials in clear text',
                'risk': 'high',
                'recommendation': 'Use SFTP or FTPS'
            })
        
        elif service['port'] == 23:  # Telnet
            vulns.append({
                'type': 'telnet_insecure',
                'issue': 'Telnet is unencrypted',
                'risk': 'high',
                'recommendation': 'Replace with SSH'
            })
        
        elif service['port'] == 445:  # SMB
            vulns.append({
                'type': 'smb_shares',
                'issue': 'SMB may expose file shares',
                'risk': 'medium',
                'recommendation': 'Restrict SMB access'
            })
        
        return vulns
    
    def check_misconfigurations(self, target):
        """Check for common misconfigurations"""
        misconfigs = []
        
        # DNS misconfigurations
        try:
            import dns.resolver
            resolver = dns.resolver.Resolver()
            
            # Check for open resolver
            try:
                answers = resolver.resolve(target, 'NS')
                misconfigs.append({
                    'type': 'dns_misconfig',
                    'check': 'DNS server responds',
                    'risk': 'info'
                })
            except:
                pass
                
        except ImportError:
            pass
        
        # SSL/TLS misconfigurations
        try:
            import ssl
            import socket
            
            context = ssl.create_default_context()
            with socket.create_connection((target, 443), timeout=3) as sock:
                with context.wrap_socket(sock, server_hostname=target) as ssock:
                    cert = ssock.getpeercert()
                    
                    # Check certificate expiry
                    import datetime
                    expiry_date = datetime.datetime.strptime(cert['notAfter'], '%b %d %H:%M:%S %Y %Z')
                    days_remaining = (expiry_date - datetime.datetime.now()).days
                    
                    if days_remaining < 30:
                        misconfigs.append({
                            'type': 'ssl_cert_expiry',
                            'issue': f'SSL certificate expires in {days_remaining} days',
                            'risk': 'high' if days_remaining < 7 else 'medium'
                        })
                        
        except:
            pass
        
        return misconfigs
    
    def check_critical_issues(self, target, services):
        """Check for critical security issues"""
        critical = []
        
        # Check for default credentials
        default_services = [
            (22, 'ssh', 'root:admin'),
            (21, 'ftp', 'anonymous:anonymous'),
            (23, 'telnet', 'root:root'),
            (3306, 'mysql', 'root:'),
            (5432, 'postgres', 'postgres:postgres'),
            (3389, 'rdp', 'Administrator:')
        ]
        
        for port, service, credentials in default_services:
            if any(s['port'] == port for s in services):
                critical.append({
                    'type': 'default_credentials_possible',
                    'service': service,
                    'port': port,
                    'issue': f'Default credentials may work for {service}',
                    'risk': 'critical'
                })
        
        # Check for exposed databases
        db_ports = [27017, 6379, 9200, 11211]
        for service in services:
            if service['port'] in db_ports:
                critical.append({
                    'type': 'exposed_database',
                    'service': service['name'],
                    'port': service['port'],
                    'issue': f'Database {service["name"]} exposed to internet',
                    'risk': 'critical'
                })
        
        return critical
